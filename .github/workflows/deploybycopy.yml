name: Deploy to EC2 on main merge

on:
  pull_request:
    branches:
      - main
    types:
      - closed

jobs:
  deploy:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Notify MS Teams
      if: always()
      run: |
        STATUS="${{ job.status }}"
        MESSAGE=" Deployment Status: $STATUS**  \n\
        **🔀 Branch:** \`${{ github.ref_name }}\`  \n\
        **🔨 Commit:** \`${{ github.sha }}\`  \n\
        **👤 Triggered by:** ${{ github.actor }}  \n\
        **📝 Commit Message:** ${{ github.event.head_commit.message }}  \n\
        **🕒 Time:** $(date '+%Y-%m-%d %H:%M:%S')  \n\
        **📁 Repository:** [${{ github.repository }}](https://github.com/${{ github.repository }})"
        curl -H 'Content-Type: application/json' \
          -d '{"text": "🚀 Deployment started for `${{ github.repository }}` by `${{ github.actor }}`"}' \
          ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
