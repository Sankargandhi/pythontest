name: Deploy to EC2 on main merge

on:
  pull_request:
    branches:
      - main
    types:
      - closed

jobs:
  deploy:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Notify MS Teams
      if: always()
      run: |
        STATUS="${{ job.status }}"
        MESSAGE=" Deployment Status: $STATUS**  \n\
        **ğŸ”€ Branch:** \`${{ github.ref_name }}\`  \n\
        **ğŸ”¨ Commit:** \`${{ github.sha }}\`  \n\
        **ğŸ‘¤ Triggered by:** ${{ github.actor }}  \n\
        **ğŸ“ Commit Message:** ${{ github.event.head_commit.message }}  \n\
        **ğŸ•’ Time:** $(date '+%Y-%m-%d %H:%M:%S')  \n\
        **ğŸ“ Repository:** [${{ github.repository }}](https://github.com/${{ github.repository }})"
        curl -H 'Content-Type: application/json' \
          -d '{"text": "ğŸš€ Deployment started for `${{ github.repository }}` by `${{ github.actor }}`"}' \
          ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
